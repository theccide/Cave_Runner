<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.3/pako.min.js"></script>
    <script src="../Jam_Engine/Graphics.js"></script>
    <script src="../Jam_Engine/Tools.js"></script>
    <script src="../Jam_Engine/UI/Button.js"></script>
    <script src="../Jam_Engine/Grid.js"></script>
    <script src="../Jam_Engine/AStar.js"></script>
    <script src="MapBuilder.js"></script>
</head>
<body>
    <canvas id="myCanvas" width="2816" height="1408"></canvas>

    <script>

        function saveCanvasToPNG(canvasId, filename) {
            // Get the canvas element based on its id
            var canvas = document.getElementById(canvasId);

            if (!canvas) {
                console.error("Canvas with ID", canvasId, "not found!");
                return;
            }

            // Convert the canvas to a Data URL in PNG format
            var imgURL = canvas.toDataURL("image/png");

            // Create an anchor element
            var link = document.createElement("a");
            link.download = filename || "canvas.png"; // Set the filename or use a default
            link.href = imgURL;

            // Append the anchor to the document and click it to start download
            document.body.appendChild(link);
            link.click();

            // Clean up by removing the anchor
            document.body.removeChild(link);
        }

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        const backBuffer = canvas.getContext('2d');

        const tileSize={ width:32, height:32 }
        const WIDTH = 2816;
        const HEIGHT = 1408;
        const numRows = HEIGHT/32;
        const numCols = WIDTH/32;
        
        console.log(numRows, numCols);

        ctx.imageSmoothingEnabled= false

        let images = {};

        // const drawWall=(wallType, start, end)=>{
        //     const alignment = (start.y == end.y)?"hor":"ver";
        //     const startEdge = images[`Images/builder/wall_types/${wallType}/${alignment}_startEdge.png`];
        //     const endEdge = images[`Images/builder/wall_types/${wallType}/${alignment}_endEdge.png`];
        //     const midEdge = images[`Images/builder/wall_types/${wallType}/${alignment}_mid.png`];
        //     const oppMidEdge = images[`Images/builder/wall_types/${wallType}/${alignment=="hor"?"ver":"hor"}_mid.png`];

        //     const wallImageSize={width, height} = midEdge;
        //     const oppositeWallImageSize={width, height} = oppMidEdge;
            
        //     const fullBounds = {
        //         x: start.x*tileSize.width,
        //         y: start.y*tileSize.height,
        //         width: ((end.x-start.x)*tileSize.width),//+tileSize.width,
        //         height: ((end.y-start.y)*tileSize.height)//+tileSize.height
        //     }
        //     const centerPos = {
        //         x: (alignment==="hor")?0:((tileSize.width-wallImageSize.width)/2),
        //         y: (alignment==="ver")?0:((tileSize.height-wallImageSize.height)/2)
        //     }
        //     const oppCenterPos = {
        //         x: (alignment==="ver")?0:((tileSize.width-oppositeWallImageSize.width)/2),
        //         y: (alignment==="hor")?0:((tileSize.height-oppositeWallImageSize.height)/2)
        //     }

        //     if(alignment==="hor"){
        //         let offset={x:fullBounds.x+centerPos.x+oppCenterPos.x,y:fullBounds.y+centerPos.y};
        //         drawImageFrom00(backBuffer, startEdge,offset.x,offset.y,startEdge.width, startEdge.height);
        //         offset={x:offset.x+startEdge.width-1,y:offset.y};
        //         let stretchLength = fullBounds.width-(startEdge.width+endEdge.width+(oppCenterPos.x*2));
        //         drawImageFrom00(backBuffer, midEdge,offset.x,offset.y, stretchLength, midEdge.height);
        //         offset={x:offset.x+stretchLength-1,y:offset.y};
        //         drawImageFrom00(backBuffer, endEdge,offset.x,offset.y,endEdge.width, endEdge.height);            
        //     }

        //     if(alignment==="ver"){
        //         let offset={x:fullBounds.x+centerPos.x,y:fullBounds.y+centerPos.y+oppCenterPos.y};
        //         drawImageFrom00(backBuffer, startEdge,offset.x,offset.y,startEdge.width, startEdge.height);
        //         offset={x:offset.x,y:offset.y+startEdge.height-1};
        //         let stretchLength = fullBounds.height-(startEdge.height+endEdge.height+(oppCenterPos.y*2));
        //         drawImageFrom00(backBuffer, midEdge,offset.x,offset.y, midEdge.width, stretchLength);
        //         offset={x:offset.x,y:offset.y+stretchLength-1};
        //         drawImageFrom00(backBuffer, endEdge,offset.x,offset.y,endEdge.width, endEdge.height);            
        //     }
        // }

            // 15 middle T
            // 14 left T
            // 13 right T
            // 12 ver 
            // 11 top T
            // 10 left top corner
            // 9  right top corner
            // 8  top
            // 7  bottom T
            // 6  left bottom corner
            // 5  right bottom corner
            // 4  bottom
            // 3  hor
            // 2  left
            // 1  right
            // 0  no wall

        const WALL_PARTS = {
            NOWALL: 0,
            RIGHT: 1,
            LEFT: 2,
            HOR: 3,
            BOTTOM: 4,
            RIGHT_BOTTOM_CORNER: 5,
            LEFT_BOTTOM_CORNER: 6,
            BOTTOM_T: 7,
            TOP: 8,
            RIGHT_TOP_CONRER: 9,
            LEFT_TOP_CONRER: 10,
            TOP_T: 11,
            VER: 12,
            RIGHT_T: 13,
            LEFT_T: 14,
            MIDDLE_T: 15
        };

        const WALL_NAMES = {
            0: 'NOWALL',
            1: 'RIGHT',
            2: 'LEFT',
            3: 'HOR',
            4: 'BOTTOM',
            5: 'RIGHT_BOTTOM_CORNER',
            6: 'LEFT_BOTTOM_CORNER',
            7: 'BOTTOM_T',
            8: 'TOP',
            9: 'RIGHT_TOP_CONRER',
            10: 'LEFT_TOP_CONRER',
            11: 'TOP_T',
            12: 'VER',
            13: 'RIGHT_T',
            14: 'LEFT_T',
            15: 'MIDDLE_T'
        };

        // console.log(DAYS.MONDAY); // Outputs: 0
        // console.log(DAY_NAMES[0]); // Outputs: 'Monday'

        const matrix = [
            [0,0,0,0,0,0,0,0],
            [0,0,0,1,0,0,0,0],
            [0,0,0,1,0,0,0,0],
            [0,1,1,1,1,1,0,0],
            [0,0,0,1,0,0,0,0],
            [0,0,0,1,0,0,0,0],
            [0,0,0,0,0,0,0,0]
        ]        
        // const matrix = [
        //     [0,0,0,0,0,0,0,0],
        //     [0,1,1,1,1,1,1,0],
        //     [0,1,0,1,0,0,1,0],
        //     [0,1,1,1,1,1,1,0],
        //     [0,1,0,1,0,0,1,0],
        //     [0,1,1,1,1,1,1,0],
        //     [0,0,0,0,0,0,0,0]
        // ]

        const setBit=(byte, position, value)=> {
            if (value === 1) { return byte | (1 << position);}            
            return byte & ~(1 << position); // If the value is 0, clear the bit.
        }

        const buildDetailedMatrix=()=>{
            let detailedMatrix = JSON.parse(JSON.stringify(matrix));
            matrix.forEach((row,y) => { 
                row.forEach((cell, x)=>{
                    let byte = 0b00000000;
                    if(matrix[y][x]==1){
                        if(x!= 0) byte = setBit(byte, 0, matrix[y][x-1]);
                        if(x < matrix[y].length) byte = setBit(byte, 1, matrix[y][x+1]);
                        if(y!= 0) byte = setBit(byte, 2, matrix[y-1][x]);
                        if(y < matrix.length) byte = setBit(byte, 3, matrix[y+1][x]);
                    }
                    detailedMatrix[y][x] = byte;
                })
            });
            console.log(detailedMatrix);
            return detailedMatrix;
        }

        const finishedLoading = (loadedImages) => {
            images = loadedImages;
            drawImageFrom00(backBuffer, images["Images/builder/grid.png"],0,0,WIDTH,HEIGHT);
            
            buildDetailedMatrix();

            // let horLines = [];
            // matrix.forEach((y,row) => { 
            //     let horLine = [];
            //     row.forEach((x, cell)=>{                    
            //         if(matrix[y][x]==1)

            //     })
            // });

            drawWall("tile1",{x:3,y:0},{x:3,y:7});
            drawWall("tile1",{x:1,y:2},{x:6,y:2});
            // drawWall("tile1",{x:0,y:0},{x:4,y:0});

            // drawWall("tile1",{x:0,y:0},{x:0,y:4});
            // drawWall("tile1",{x:0,y:3},{x:4,y:3});

            //saveCanvasToPNG("myCanvas", "myImage.png");
        }

        const setupTilesToLoad=(tileName)=>{
            const path = `Images/builder/wall_types/${tileName}`;
            let tilesToLoad = [];
            Object.values(WALL_NAMES).forEach(wallFile => {
                if(wallFile!=="NOWALL") tilesToLoad.push(`${path}/${wallFile}.png`);
            });
            return tilesToLoad;
        }

        let otherImagesToLoad = ["Images/builder/grid.png"];
        let imagesToLoad = setupTilesToLoad("tile1");
        imagesToLoad = [...imagesToLoad, ...otherImagesToLoad];
        loadImages(imagesToLoad,finishedLoading);

        // loadImages([
        //     "Images/builder/grid.png",
        //     // "Images/builder/wall_types/tile1/hor_startEdge.png",
        //     // "Images/builder/wall_types/tile1/hor_endEdge.png",
        //     // "Images/builder/wall_types/tile1/hor_mid.png",
        //     // "Images/builder/wall_types/tile1/ver_startEdge.png",
        //     // "Images/builder/wall_types/tile1/ver_endEdge.png",
        //     // "Images/builder/wall_types/tile1/ver_mid.png",

        //     "Images/builder/wall_types/tile1/top.png",
        //     "Images/builder/wall_types/tile1/bottom.png",
        //     "Images/builder/wall_types/tile1/left.png",
        //     "Images/builder/wall_types/tile1/right.png",
        //     "Images/builder/wall_types/tile1/hor.png",
        //     "Images/builder/wall_types/tile1/ver.png",
        //     "Images/builder/wall_types/tile1/topright.png",
        //     "Images/builder/wall_types/tile1/topleft.png",
        //     "Images/builder/wall_types/tile1/botright.png",
        //     "Images/builder/wall_types/tile1/botleft.png",
        //     "Images/builder/wall_types/tile1/left_t.png",
        //     "Images/builder/wall_types/tile1/right_t.png",
        //     "Images/builder/wall_types/tile1/top_t.png",
        //     "Images/builder/wall_types/tile1/bot_t.png"
        // ],finishedLoading);
        
    </script>
</body>
</html>
